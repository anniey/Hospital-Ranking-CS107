---
title: "Create HCAHPS Map"
output: html_document
---



```{r}
library(choroplethr)
library(choroplethrZip) 
library(choroplethrMaps)
library(dplyr)

hcahps <- read.csv("https://raw.githubusercontent.com/anniey/Hospital-Ranking-CS107/master/Raw%20Data/hcahps.csv") #national

map_star <- read.csv("https://raw.githubusercontent.com/anniey/Hospital-Ranking-CS107/master/Raw%20Data/For%20Map%20only.csv")

#let's show the HCAHPS Star rating by county in US
colnames(map_star) <- c("county.name", "value")

map_star <- map_star %>%
  filter(value != "Not Available", value != "Not Applicable", county.name != "")

map_star$value <- as.numeric(as.character(map_star$value)) 
map_star$county.name <- tolower(map_star$county.name)

#map the counties to fips
data(county.regions)
map_star <- map_star %>%
  left_join(county.regions, by = "county.name") %>%
  select(c(region, value)) %>%
  group_by(region) %>%
  summarise(value = mean(value))

county_choropleth(map_star, 
                  title = "US HCAHPS Average Star Rating by County", legend = "Average Star Rating")

  
#filter for just NYC
df_star_zip <- hcahps %>%
  filter(HCAHPS.Measure.ID == "H_STAR_RATING") %>%
  select(c(ZIP.Code, Patient.Survey.Star.Rating)) 

colnames(df_star_zip) <- c("region", "value")

df_star_zip$value <- as.numeric(as.character(df_star_zip$value)) 

df_star_zip <- df_star_zip %>%
  na.omit() %>%
  group_by(region) %>%
  summarise(value = mean(value))

df_star_zip$region <- as.character(df_star_zip$region)

#map the star ratings for NYC
nycmap = ZipChoropleth$new(df_star_zip)
nyc_fips = c(36005, 36047, 36061, 36081, 36085)
zip_choropleth(df_star_zip, 
               county_zoom=nyc_fips, 
               title="HCAHPS Star Rating by Zip Code for NYC",
               legend="Star Rating")

```


